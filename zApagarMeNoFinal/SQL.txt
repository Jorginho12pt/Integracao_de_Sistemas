USE SistemaWeb;
GO
CREATE TRIGGER InsercaoTrigger ON Testes AFTER INSERT
AS
BEGIN 
	IF @@rowcount = 0 RETURN;
	-- Precisa de optimização nas variavei, nos ifs , e @_TempoProducao
	DECLARE @_IdProduto int;
	DECLARE @_CodigoPeca char(8);
	DECLARE @_TempoProducao time(0);
	DECLARE @_TempoProducaoFix int; -- tenho que alterar este valor para int em vez de time
	DECLARE @_CustoProducao float;
	DECLARE @_Lucro float;
	DECLARE @_Prejuizo float;
	DECLARE @_CodigoResultado int;
	DECLARE @_CustoValor float;
	DECLARE @_IdCusto int;

	SELECT @_IdProduto = IdProduto
    FROM INSERTED;
	SELECT @_CodigoResultado = CodigoResultado
    FROM INSERTED;

	SET @_CodigoPeca = (SELECT CodigoPeca FROM [SistemaWeb].[dbo].[Produto] WHERE IdProduto = @_IdProduto)
	SET @_TempoProducao = (SELECT TempoProducao FROM [SistemaWeb].[dbo].[Produto] WHERE IdProduto = @_IdProduto)
	SET @_CustoValor = (SELECT CustoValor FROM [SistemaContabilidade].[dbo].[CustoTipoFalha] WHERE CustoTipo = @_CodigoResultado)
	 
	SET @_TempoProducaoFix = CAST(RIGHT(@_TempoProducao, 2) AS INT);



    IF @_CodigoPeca LIKE 'aa%' 
    BEGIN
        SET @_CustoProducao = @_TempoProducaoFix * 1.9;
		SET @_Prejuizo = (@_TempoProducaoFix + 0.9) + (@_CustoValor);
		SET @_Lucro = 120 - (@_CustoProducao + @_Prejuizo);
    END
    ELSE IF @_CodigoPeca LIKE 'ab%' 
    BEGIN
        SET @_CustoProducao = @_TempoProducaoFix * 1.3;
		SET @_Prejuizo = (@_TempoProducaoFix + 1.1) + (@_CustoValor);
		SET @_Lucro = 100 - (@_CustoProducao + @_Prejuizo);
    END
    ELSE IF @_CodigoPeca LIKE 'ba%' 
    BEGIN
        SET @_CustoProducao = @_TempoProducaoFix * 1.7;
		SET @_Prejuizo = (@_TempoProducaoFix + 1.2) + (@_CustoValor);
		SET @_Lucro = 110 - (@_CustoProducao + @_Prejuizo);
    END
    ELSE IF @_CodigoPeca LIKE 'bb%' 
    BEGIN
        SET @_CustoProducao = @_TempoProducaoFix * 1.2;
		SET @_Prejuizo = (@_TempoProducaoFix + 1.3) + (@_CustoValor);
		SET @_Lucro = 90 - (@_CustoProducao + @_Prejuizo);
    END
    ELSE 
    BEGIN
        SET @_CustoProducao = @_TempoProducaoFix * 1.9;
		SET @_Prejuizo = (@_TempoProducaoFix + 0.9) + (@_CustoValor);
		SET @_Lucro = 120 - (@_CustoProducao + @_Prejuizo);
    END

		SELECT @_IdCusto =IdCusto
		FROM [SistemaContabilidade].[dbo].[CustosPeca]
		WHERE IdProduto = @_IdProduto;

		IF @_IdCusto IS NOT NULL
        BEGIN	
			UPDATE [SistemaContabilidade].[dbo].[CustosPeca]
			SET CodigoPeca = @_CodigoPeca, TempoProducao = @_TempoProducao, CustoProducao = @_CustoProducao, Lucro = @_Lucro, Prejuizo = @_Prejuizo
			WHERE IdProduto = @_IdProduto;
        END
        ELSE
        BEGIN
            INSERT INTO [SistemaContabilidade].[dbo].[CustosPeca] (IdProduto, CodigoPeca, TempoProducao, CustoProducao, Lucro, Prejuizo)
            VALUES (@_IdProduto,@_CodigoPeca, @_TempoProducao, @_CustoProducao, @_Lucro,@_Prejuizo);
        END

END;
GO